<div class="box mt-5">
  <div class="flex-container">
    <div id="{{ plot_info[0] }}" class="plot"></div>
    <i class="drag-handle" data-lucide="grip"></i>
    <i class="expand-icon" data-lucide="expand"></i>
  </div>
  <div id="{{ plot_info[1] }}" style="width: 100%; height: 100%;"></div>
  <div class="content">
    <h2>{{ explainations.get(plot_info[0]).title }}</h2>
    <p>{{ explainations.get(plot_info[0]).content }}</p>
    {% if explainations.get(plot_info[0]).formula != "" %}
    <div class="formula">
      {{ explainations.get(plot_info[0]).formula | safe }}
    </div>
    {% endif %}
  </div>
  <script>
    var plotData_{{ plot_info[1] }} = {{ plot_info[2] | safe }};
    
    // Initial plot with the main data
    var config = {
      responsive: true,
      autosize: true
    };
    
    // Create layout options to better fit the container
    var layout = {
      margin: { t: 10, r: 10, l: 50, b: 50 },
      autosize: true
    };
    
    // Initialize plot and ensure it's properly sized
    Plotly.newPlot('{{ plot_info[1] }}', plotData_{{ plot_info[1] }}, layout, config).then(() => {
      // Force a resize after plot is created to ensure it fills the container
      setTimeout(() => {
          Plotly.Plots.resize(document.getElementById('{{ plot_info[1] }}'));
          console.log('t-SNE plot initialized successfully');
      }, 100);
    });
    
    var currentPlot_{{ plot_info[1] }} = document.getElementById('{{ plot_info[1] }}');
    currentPlot_{{ plot_info[1] }}.on('plotly_click', function(data) {
        // Extract frame number from the clicked point's text
        const pointText = data.points[0].text;
        const frameNumber = parseInt(pointText.split(': ')[1]);
        
        console.log('t-SNE plot clicked, frame:', frameNumber);
        
        // Update the 3D viewer
        LouisMolStarWrapper.interactivity.changeFrame(frameNumber);
        
        // Update slider and frame number input to stay synchronized
        const frameSlider = document.getElementById('frame-slider');
        const frameNumberInput = document.getElementById('frame-number');
        if (frameSlider) frameSlider.value = frameNumber;
        if (frameNumberInput) frameNumberInput.value = frameNumber;

        // Update all frame markers across all plots using the global manager
        if (typeof frameMarkers !== 'undefined') {
            frameMarkers.updateAll(frameNumber);
        }

        // Update contact map if socket is available
        if (typeof io !== 'undefined') {
            const socket = io.connect((location.protocol === 'https:' ? 'https://' : 'http://') + document.domain + ":" + location.port, {
                query: "session_id={{ session_id }}"
            });
            socket.emit("update_contact_map", {
                value: frameNumber,
                session_id: "{{ session_id }}"
            }, "{{ session_id }}");
        }
    });
    
    // Debounce function to prevent excessive resize calls
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
    
    // Add debounced resize event listener
    window.addEventListener('resize', debounce(() => {
      Plotly.Plots.resize(document.getElementById('{{ plot_info[1] }}'))
    }, 250));
    
    // Handle expand button click
    document.querySelector(".expand-icon").addEventListener('click', () => {
      Plotly.Plots.resize(document.getElementById('{{ plot_info[1] }}'));
    });
    
  </script>
  <div
    style="
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
    "
  >
    <a
      href="{{ url_for('download_plot_data', plot_id=plot_info[0], session_id=session_id) }}"
      class="button is-link"
    >Download {{ plot_info[0] }} Data</a>
    <a
      href="{{ url_for('download_plot', plot_id=plot_info[0], session_id=session_id) }}"
      class="button is-link"
    >Download Plot</a>
  </div>
</div>