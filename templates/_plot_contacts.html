<div class="box mt-5">
  <div class="flex-container">
    <div id="{{ plot_info[0] }}" class="plot"></div>
    <!-- <i class="drag-handle" data-lucide="grip"></i> -->
    <!-- <i class="expand-icon" data-lucide="expand"></i> -->
  </div>
  <div id="{{ plot_info[1] }}" style="width: 100%; height: 100%;"></div>
  <div class="content">
    <h2>{{ explainations.get(plot_info[0]).title }}</h2>
    <p>{{ explainations.get(plot_info[0]).content }}</p>
    {% if explainations.get(plot_info[0]).formula != "" %}
    <div class="formula">
      {{ explainations.get(plot_info[0]).formula | safe }}
    </div>
    {% endif %}
  </div>

    <script>
    var previousValue2 = 1;
    var dataLength = {{ trajectory_length }};
    var plotDataContact_{{ plot_info[1] }} = {{ plot_info[2] | safe }};
    var plotDataStacking_{{ plot_info[1] }} = null; // Will be loaded dynamically
    var currentMode = 'contact'; // Track the current display mode

    // Initial plot with the contact map data
    var socket = io.connect((location.protocol === 'https:' ? 'https://' : 'http://') + document.domain + ":" + location.port, {
      query: "session_id={{ session_id }}"
    });
    socket.emit('join', { room: "{{ session_id }}" });

    // Initialize plot with contact map data by default
    Plotly.newPlot('{{ plot_info[1] }}', plotDataContact_{{ plot_info[1] }}).then(() => {
      // Force a resize after plot is created to ensure it fills the container
      setTimeout(() => {
        Plotly.Plots.resize(document.getElementById('{{ plot_info[1] }}'));
        console.log('Contact map initialized and resized');
        
        // Register contact map for frame updates using a custom approach
        if (typeof window.contactMapFrameListeners === 'undefined') {
          window.contactMapFrameListeners = [];
        }
        window.contactMapFrameListeners.push({
          plotId: '{{ plot_info[1] }}',
          sendSliderValue: sendSliderValue,
          sendStackingSliderValue: sendStackingSliderValue
        });
        console.log('Contact map registered for frame updates');
      }, 100);
      
      // Pre-load stacking data for the initial frame
      sendStackingSliderValue(previousValue2);
    });

    // Function to switch between contact map and stacking map modes
    function switchContactMode(mode) {
      const plotDiv = document.getElementById('{{ plot_info[1] }}');
      
      if (mode === 'contact') {
        Plotly.react(plotDiv, plotDataContact_{{ plot_info[1] }});
        document.getElementById('btnContactMap').classList.add('is-active');
        document.getElementById('btnStackingMap').classList.remove('is-active');
        currentMode = 'contact';
      } else if (mode === 'stacking') {
        if (plotDataStacking_{{ plot_info[1] }}) {
          Plotly.react(plotDiv, plotDataStacking_{{ plot_info[1] }});
          document.getElementById('btnStackingMap').classList.add('is-active');
          document.getElementById('btnContactMap').classList.remove('is-active');
          currentMode = 'stacking';
        } else {
          // Load stacking data for the first time
          sendStackingSliderValue(previousValue2);
        }
      }
    }

    // Connect to websocket for updates
    var debounceTimeout;

    // Debounce function
    function debounce(func, delay) {
      return function() {
        var context = this;
        var args = arguments;
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(function() {
          func.apply(context, args);
        }, delay);
      };
    }

    // Add debounced resize event listener
    window.addEventListener('resize', debounce(() => {
      Plotly.Plots.resize(document.getElementById('{{ plot_info[1] }}'))
    }, 250));

    // Handle expand button click
    document.querySelector(".expand-icon").addEventListener('click', () => {
      Plotly.Plots.resize(document.getElementById('{{ plot_info[1] }}'));
    });

    // Send slider value to server
    function sendSliderValue(value) {
      console.log('Contact map: Sending contact map update for frame', value);
      socket.emit("update_contact_map", {
        value: value,
        session_id: "{{ session_id }}",
      }, "{{ session_id }}");
    }


    function sendStackingSliderValue(value) {
      console.log('Contact map: Sending stacking map update for frame', value);
      socket.emit("update_stacking_map", {
        value: value,
        session_id: "{{ session_id }}",
      }, "{{ session_id }}");
    }

    // Add event listeners for slider and input with error handling
    const frameSlider = document.getElementById('frame-slider');
    const frameNumber = document.getElementById('frame-number');
    
    if (frameSlider) {

      const socket = io.connect((location.protocol === 'https:' ? 'https://' : 'http://') + document.domain + ":" + location.port, {
          query: "session_id={{ session_id }}"
      });
      frameSlider.addEventListener('input', 
        debounce(function() {
          var sliderValue = parseInt(this.value);
          previousValue2 = sliderValue;
          console.log('Contact map: Frame slider changed to', sliderValue);
          // Always request both contact and stacking data when frame changes
          sendSliderValue(sliderValue);
          sendStackingSliderValue(sliderValue);
        }, 500)
      );
      console.log('Contact map: Frame slider event listener added');
    } else {
      console.log('Contact map: Frame slider not found');
    }

    if (frameNumber) {
      frameNumber.addEventListener('input',
        debounce(function() {
          var sliderValue = parseInt(this.value);
          previousValue2 = sliderValue;
          console.log('Contact map: Frame number input changed to', sliderValue);
          // Always request both contact and stacking data when frame changes
          sendSliderValue(sliderValue);
          sendStackingSliderValue(sliderValue);
        }, 500)
      );
      console.log('Contact map: Frame number input event listener added');
    } else {
      console.log('Contact map: Frame number input not found');
    }

    // Update plot when receiving new data from server
    socket.on("contact_map_plot_update", function(data) {
      const plotData = JSON.parse(data.plotData);
      
      // Always store the updated contact data
      plotDataContact_{{ plot_info[1] }} = plotData.data;
      
      // Only update the display if currently in contact mode
      if (currentMode === 'contact') {
        Plotly.react(document.getElementById('{{ plot_info[1] }}'), plotData.data);
        console.log('Contact map updated via socket for frame');
      }
    });

    // Update plot when receiving new stacking data from server
    socket.on("stacking_map_plot_update", function(data) {
      const plotData = JSON.parse(data.plotData);
      
      // Always store the updated stacking data
      plotDataStacking_{{ plot_info[1] }} = plotData.data;
      
      // Only update the display if currently in stacking mode
      if (currentMode === 'stacking') {
        Plotly.react(document.getElementById('{{ plot_info[1] }}'), plotData.data);
        document.getElementById('btnStackingMap').classList.add('is-active');
        document.getElementById('btnContactMap').classList.remove('is-active');
        currentMode = 'stacking';
        console.log('Stacking map updated via socket for frame');
      }
    });
  </script>

  <!-- Toggle buttons for Contact Map/Stacking Map -->
  <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px; margin-bottom: 10px;">
    <button id="btnContactMap" class="button is-link is-active" onclick="switchContactMode('contact')">Contact Map</button>
    <button id="btnStackingMap" class="button is-link" onclick="switchContactMode('stacking')">Stacking Map</button>
  </div>

  <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
    <a href="{{ url_for('download_plot_data', plot_id=plot_info[0], session_id=session_id) }}" class="button is-link">Download {{ plot_info[0] }} Data</a>
    <a href="{{ url_for('download_plot', plot_id=plot_info[0], session_id=session_id) }}" class="button is-link">Download Plot</a>
  </div>
</div>
